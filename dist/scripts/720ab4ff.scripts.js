"use strict";angular.module("geckoApp",["ngResource","ui.bootstrap","ngProgress","highcharts-ng","ui.select2"]),angular.module("geckoApp").controller("MainCtrl",["$scope","$rootScope","$interval","dateParseService",function(a,b,c,d){b.data||(b.data={}),a.$watch(function(){return b.data.datesArr},function(c,e){c!==e&&(a.dates=b.data.datesArr,a.dateSelected=d.parse(b.data.datesArr[0]),a.datesPresent=!0,a.currentData=b.data.currentDate,a.minDate=b.data.datesArr[0],a.maxDate=d.parse(b.data.datesArr[b.data.datesArr.length-1]),a.sectors=b.data.sector2subSector)}),a.clicked=function(){a.dateSelected=a.dateSelected,h=b.data.datesArr.indexOf(a.dateSelected.toISOString().substring(0,10))},a.sectorColor=function(a){return{background:b.data.colors[a],"vertical-align":"middle"}},a.dateInvalid=function(a,c){if(!b.data.datesArr)return!0;try{return"day"===c?!b.data.validDates[a.getFullYear()][a.getMonth()+1][a.getDate()]:"year"===c?!b.data.validDates[a.getFullYear()]:!b.data.validDates[a.getFullYear()][a.getMonth()+1]}catch(d){return b.data.validDates?!0:!1}},a.isActive=function(b){return b===a.dateControlPanel?"active":""},a.dateControlPanel="pause";var e,f=1,g=1,h=0;a.dateControl=function(i){var j=function(){e=c(function(){0===h&&-1===g||1===g&&h===b.data.datesArr.length-1?(c.cancel(e),e=void 0,a.dateControlPanel="pause"):(h+=g,a.dateSelected=d.parse(b.data.datesArr[h]))},1500/f,0,!0)};switch(c.cancel(e),e=void 0,i){case"fast-backward":a.dateControlPanel="fast-backward",console.log("fast-backward"),a.dateSelected=d.parse(b.data.datesArr[0]),h=0,a.dateControlPanel="pause";break;case"backward":a.dateControlPanel="backward",console.log("backward"),g=-1,f=1,j();break;case"pause":a.dateControlPanel="pause",console.log("pause");break;case"play":a.dateControlPanel="play",console.log("play"),g=1,f=1,j();break;case"forward":a.dateControlPanel="forward",console.log("forward"),g=1,f=3,j();break;case"fast-forward":a.dateControlPanel="fast-forward",console.log("fast-forward"),a.dateSelected=d.parse(b.data.datesArr[b.data.datesArr.length-1]),h=b.data.datesArr.length-1,a.dateControlPanel="pause";break;default:console.log("do nothing!")}}}]),angular.module("geckoApp").service("TreemapDataService",["$http","$rootScope","apiUrl",function(a,b,c){var d,e=[],f={name:"Treemap",children:[]};b.data={},b.data.datesArr=[],b.data.weightsDB={},b.data.sector2subSector={},b.data.subSector2sector={};var g=function(a){e.push(a)};a.get(c+"/map/").success(function(a){for(var c=0,d=a.length;d>c;c++)b.data.sector2subSector[a[c].sector]||f.children.push({name:a[c].sector,children:[]}),b.data.sector2subSector[a[c].sector]?b.data.sector2subSector[a[c].sector].push(a[c].sub_sector):b.data.sector2subSector[a[c].sector]=[a[c].sub_sector],b.data.subSector2sector[a[c].sub_sector]=a[c].sector});var h=function(a){return{year:Number(a.substring(0,4)),month:Number(a.substring(5,7)),day:Number(a.substring(8))}};a.get(c+"/dates").success(function(g){b.data.datesArr=g,b.data.validDates={},b.data.currentDate=d=b.data.datesArr[0],a.get(c+"/weights/"+d).success(function(a){b.data.weightsDB[d]=a,i(a);for(var c in e)e[c](null,f)});for(var j,k=b.data.datesArr.length-1;k>=0;k--)j=h(b.data.datesArr[k]),b.data.validDates[j.year]||(b.data.validDates[j.year]={}),b.data.validDates[j.year][j.month]||(b.data.validDates[j.year][j.month]={}),b.data.validDates[j.year][j.month][j.day]||(b.data.validDates[j.year][j.month][j.day]=!0)});var i=function(a){for(var c={},d=0,e=a.length;e>d;d++)a[d].name=a[d].sub_sector,c[b.data.subSector2sector[a[d].sub_sector]]?c[b.data.subSector2sector[a[d].sub_sector]].push(angular.copy(a[d],{})):c[b.data.subSector2sector[a[d].sub_sector]]=[angular.copy(a[d],{})];for(var d=0,e=f.children.length;e>d;d++)f.children[d].children=c[f.children[d].name]},j=function(a){for(var b={},c=0,d=a.length;d>c;c++)a[c].name=a[c].sub_sector,b[a[c].sub_sector]=a[c];for(var c=0,d=f.children.length;d>c;c++)for(var e=0,g=f.children[c].children.length;g>e;e++)b[f.children[c].children[e].name]&&(f.children[c].children[e].weight=b[f.children[c].children[e].name].weight)},k=function(e,g){-1!==b.data.datesArr.indexOf(e)&&(d=e,b.data.weightsDB[d]?(j(b.data.weightsDB[d]),g(null,f)):a.get(c+"/weights/"+d).success(function(a){b.data.weightsDB[d]=a,j(a),g(null,f)}))};return{data:f,setDate:k,onload:g}}]),angular.module("geckoApp").directive("treemap",["TreemapDataService","$rootScope","HighChartsModal",function(a,b,c){return{restrict:"E",transclude:!0,scope:{date:"="},link:function(d,e){function f(){this.style("left",function(a){return a.x+"px"}).style("top",function(a){return a.y+"px"}).attr("width",function(a){return Math.max(0,a.dx-1)+"px"}).attr("height",function(a){return Math.max(0,a.dy-1)+"px"})}b.data.colors={};var g={top:50,right:0,bottom:0,left:0},h=angular.element(window).width(),i=angular.element(window).height()-50,j=h/2,k=d3.scale.category20c(),l=d3.tip().attr("class","d3-tip").direction(function(a){return a.x>=j?"w":"e"}).html(function(a){return a.name}),m=d3.layout.treemap().size([h,i]).sticky(!0).value(function(a){return a.weight}),n=d3.select(e[0]).append("div").style("position","relative").style("width",h+g.left+g.right+"px").style("height",i+g.top+g.bottom+"px").append("svg:svg").style("margin-top","50px").attr("width",h).attr("height",i).append("svg:g").attr("transform","translate(.5,.5)");a.onload(function(e,g){e&&console.error(e);var h,i;i=h=g,n.call(l);var j=m.nodes(h).filter(function(a){return!a.children}),o=n.datum(g).selectAll(".cell").data(j).enter().append("svg:g").attr("class","cell").attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).on("click",function(a){c.open(a)}).on("mouseenter",function(a){l.attr("class","d3-tip animate").show(a)}).on("mouseleave",function(a){l.attr("class","d3-tip").show(a),l.hide()});o.append("svg:rect").call(f).style("fill",function(a){return b.data.colors[a.parent.name]=k(a.parent.name),k(a.parent.name)}),o.append("svg:text").attr("x",function(a){return a.dx/2}).attr("y",function(a){return a.dy/2}).attr("dy",".35em").attr("class","font-smoothing").attr("text-anchor","middle").text(function(a){return a.name}).style("writing-mode",function(a){return a.w=this.getComputedTextLength(),a.dx<a.w&&a.dy>a.w?"tb":""}).style("opacity",function(a){return a.dx>a.w||a.dy>a.w?1:0}),d.$watch(function(){return d.$parent.dateSelected},function(b,c){if(b!==c){var d=angular.isDate(b)?b.toISOString().substring(0,10):b;a.setDate(d,function(a){if(a)return console.error(a);m.nodes(d).filter(function(a){return!a.children});var b=n.selectAll("g.cell").transition().duration(1500).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});b.select("rect").attr("width",function(a){return a.dx-1}).attr("height",function(a){return a.dy-1}),b.select("text").attr("x",function(a){return a.dx/2}).attr("y",function(a){return a.dy/2}).style("opacity",function(a){return a.dx>a.w||a.dy>a.w?1:0})})}})})}}}]),angular.module("geckoApp").service("dateParseService",function(){var a=function(a){if(a){var b=a.substring(0,4),c=a.substring(5,7),d=a.substring(8),e=new Date;return e.setDate(d),e.setMonth(c),e.setFullYear(b),new Date(Number(b),Number(c-1),Number(d))}},b=function(a,b){return new Date(Number(b),Number(a-1))};return{parse:a,miniParse:b}}),angular.module("geckoApp").service("HighChartsModal",["$modal",function(a){var b,c=function(c){b=a.open({templateUrl:"views/highcharts-dialog.html",controller:"HighchartsCtrl",resolve:{sector:function(){return c.parent.name},subsector:function(){return c.name}}})};return{open:c}}]),angular.module("geckoApp").controller("HighchartsCtrl",["$scope","$modalInstance","sector","subsector","SeriesData","$compile","$rootScope","dateParseService","$interval","$timeout","$window",function(a,b,c,d,e,f,g,h,i,j,k){a.sector=c;var l=[];a.select2Options={multiple:!0},a.months=[];for(var m in g.data.validDates)for(var n in g.data.validDates[m])a.months.push(h.miniParse(n,m));!function(){var b=[];for(var c in g.data.sector2subSector)b.push({name:c,data:angular.copy(g.data.sector2subSector[c])});a.sectors=b}(),e.get(c,function(b,c){b&&console.error("err:",b),l=c,a.select2=[];for(var d=c.length-1;d>=0;d--)a.select2.push(c[d].name);a.chartConfig={useHighStocks:!0,yAxis:{labels:{formatter:function(){return(this.value>0?"+":"")+this.value+"%"}},plotLines:[{value:0,width:2,color:"silver"}]},options:{rangeSelector:{buttonTheme:{style:{display:"none"}},inputEnabled:!0,selected:4},navigator:{enabled:!0,series:{id:"nav"},adaptToUpdatedData:!0},plotOptions:{series:{compare:"value"}},tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.change}%)<br/>',valueDecimals:2}},xAxis:{},series:l};var e=angular.element(document.createElement("highchart")).attr("id","chart").attr("config","chartConfig").attr("style","width: 858px"),h=f(e)(a);g.data.chart=k.Highcharts.charts[0],angular.element("#chart-container").append(e),a.insertHere=h});var o=void 0,p=void 0;i(function(){(Math.round(g.data.chart.xAxis[0].min)!==o||Math.round(g.data.chart.xAxis[0].max)!==p)&&(o=Math.round(g.data.chart.xAxis[0].min),p=Math.round(g.data.chart.xAxis[0].max),q())},750);var q=function(){var b=function(a,b,c){if(!angular.isDefined(a))return-1;for(var d=0,e=b.length;e>d;d++)if(b[d][0]<=a&&e>d+1&&b[d+1][0]>=a)return c?++d:d;return-1};try{for(var c=[],d=0,e=a.chartConfig.series.length;e>d;d++){var f=b(Math.round(g.data.chart.xAxis[0].min),angular.copy(a.chartConfig.series[d].data,[]),!1),h=b(Math.round(g.data.chart.xAxis[0].max),angular.copy(a.chartConfig.series[d].data,[]),!0);angular.isNumber(f)&&-1!==f||(f=0),angular.isNumber(h)&&-1!==h||(h=a.chartConfig.series[d].data.length-1);var i=a.chartConfig.series[d].data.slice(f,h).sort(function(a,b){return a[1]===b[1]?0:a[1]>b[1]?1:-1});c.push({subsector:angular.copy(a.chartConfig.series[d].name),max:i[i.length-1][1],min:i[0][1]})}a.minMaxArr=c}catch(j){console.error(j)}};a.minMaxArr=[],a.selectedMonth="noMonth",a.changeRange=function(b){var c;c=1===b.getMonth()?28:-1!==[0,2,4,6,7,9,11].indexOf(b.getMonth())?31:30;var d=Date.UTC(b.getFullYear(),b.getMonth(),1),e=Date.UTC(b.getFullYear(),b.getMonth(),c);a.chartConfig.xAxis.min=d,a.chartConfig.xAxis.max=e},a.update=function(b){e.update(b,function(b,c){a.chartConfig.series=c,q()})},a.ok=function(){b.close("close")},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("geckoApp").service("SeriesData",["$rootScope","$http","apiUrl",function(a,b,c){a.data.series={};var d=function(a,d){for(var e=a.length,f=[],g=a.length-1;g>=0;g--)b.get(c+"/series/"+angular.copy(a[g]).replace(" ","%20").replace("&","%26")).success(function(a,b,g,h){var i=h.url.substring(c.length+8).replace("%20"," ").replace("%26","&");f.push({name:i,data:a}),e--,0===e&&d(null,f)})},e=function(d,e){var f,f=[];a.data.series[d]={};for(var g=a.data.sector2subSector[d].length,h=a.data.sector2subSector[d].length-1;h>=0;h--)b.get(c+"/series/"+angular.copy(a.data.sector2subSector[d][h]).replace(" ","%20").replace("&","%26")).success(function(b,h,i,j){var k=j.url.substring(c.length+8).replace("%20"," ").replace("%26","&");a.data.series[d][k]={name:k,data:b},f.push({name:k,data:b}),g--,0===g&&e(null,f)})};return{get:e,update:d}}]),angular.module("geckoApp").filter("chartFilter",function(){return function(a){var b;switch(a.getMonth()){case 0:b="January";break;case 1:b="February";break;case 2:b="March";break;case 3:b="April";break;case 4:b="May";break;case 5:b="June";break;case 6:b="July";break;case 7:b="August";break;case 8:b="September";break;case 9:b="October";break;case 10:b="November";break;case 11:b="December";break;default:console.log("Error occured!")}var c=a.getYear()-100;return b+" '"+c}}),angular.module("geckoApp").filter("dollars",function(){return function(a){return"$"+parseInt(100*parseFloat(a))/100}}),angular.module("geckoApp").constant("apiUrl","http://api.gekko.stolarsky.com");